// ADIMAGENDO - Study participant management
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  PARTICIPANT
  ADMIN
}

enum ChecklistItemType {
  SCAN
  BLOOD_TEST
  SURVEY
  UPLOAD
  APPOINTMENT
  OTHER
}

enum ChecklistStatus {
  PENDING
  COMPLETED
  OVERDUE
}

enum AbsenceReason {
  MEDICAL
  SYMPTOMS
  APPOINTMENT
  OTHER
}

enum DocumentType {
  REPORT_CARD
  REFERRAL
  OTHER
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?
  name          String?
  image         String?
  role          Role      @default(PARTICIPANT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  profile          ParticipantProfile?
  checklist        ParticipantChecklistItem[]
  symptoms         SymptomEntry[]
  absences         AbsenceEntry[]
  surveyResponses  SurveyResponse[]
  appointments     Appointment[]
  documents        Document[]
  notifications    Notification[]
  contactMessages  ContactMessage[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token     String?
  expires_at       Int?
  token_type       String?
  scope            String?
  id_token         String?
  session_state    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ParticipantProfile {
  id             String   @id @default(cuid())
  userId        String   @unique
  enrollmentDate DateTime
  studyPhase    String?  // e.g. "baseline", "3-month", etc.
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ChecklistTemplate {
  id             String           @id @default(cuid())
  key            String           @unique
  title          String
  description   String?
  type          ChecklistItemType
  externalUrl   String?
  dueOffsetDays Int?
  sortOrder     Int              @default(0)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  participantItems ParticipantChecklistItem[]
}

model ParticipantChecklistItem {
  id         String         @id @default(cuid())
  userId     String
  templateId String
  status     ChecklistStatus @default(PENDING)
  completedAt DateTime?
  notes      String?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  template ChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([userId, templateId])
}

model SymptomEntry {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime
  painLevel   Int?     // 1-10
  symptoms    Json     // e.g. ["cramping", "fatigue"] - stored as JSON array for SQLite
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

model AbsenceEntry {
  id        String        @id @default(cuid())
  userId    String
  date      DateTime
  halfDay   Boolean       @default(false)
  reason    AbsenceReason
  context   String?       // "work" | "school"
  notes     String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SurveyTemplate {
  id          String   @id @default(cuid())
  key         String   @unique // e.g. "qol_baseline", "qol_3m"
  title       String
  description String?
  intervalMonths Int   // 0, 3, 6, 9, 12
  questions   Json     // Array of question configs
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  responses SurveyResponse[]
}

model SurveyResponse {
  id         String   @id @default(cuid())
  userId     String
  templateId String
  answers    Json     // Question id -> answer
  completed  Boolean  @default(false)
  completedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  template SurveyTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([userId, templateId])
}

model Appointment {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  startAt     DateTime
  endAt       DateTime?
  location    String?
  externalUrl String?  // Link to booking
  addedToCalendar Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Document {
  id          String       @id @default(cuid())
  userId      String
  type        DocumentType
  title       String
  storageKey  String       // S3/key or upload path
  mimeType    String?
  sizeBytes   Int?
  isReferral  Boolean      @default(false) // Sent by admin to participant
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  body      String?
  type      String?  // "appointment", "survey", "referral", etc.
  read      Boolean  @default(false)
  emailSent Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ContactMessage {
  id        String   @id @default(cuid())
  userId    String
  subject   String
  message   String
  category  String?  // General, Technical, etc.
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model NewsPost {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  content   String
  excerpt   String?
  published Boolean  @default(false)
  publishedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
